<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Tablica zada≈Ñ</title>
    <!-- React + ReactDOM z CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Drag & Drop -->
    <script src="https://unpkg.com/react-beautiful-dnd@13.1.0/dist/react-beautiful-dnd.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { margin: 0; font-family: sans-serif; }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;
      const { DragDropContext, Droppable, Draggable } = window.ReactBeautifulDnd;

      // --- Tw√≥j komponent TaskBoard ---
      function TaskBoard() {
        const [users, setUsers] = useState(() => {
          const saved = localStorage.getItem("users");
          return saved ? JSON.parse(saved) : [
            { id: "admin", name: "Administrator", isAdmin: true, showColumn: false },
            { id: "artur", name: "Artur", isAdmin: false, showColumn: true },
            { id: "mateusz", name: "Mateusz", isAdmin: false, showColumn: true },
          ];
        });

        const [tasks, setTasks] = useState(() => {
          const saved = localStorage.getItem("tasks");
          return saved ? JSON.parse(saved) : {
            unassigned: [],
            artur: [],
            mateusz: [],
            zrealizowane: [],
          };
        });

        const [currentUser, setCurrentUser] = useState(() => {
          const saved = localStorage.getItem("currentUser");
          return saved ? JSON.parse(saved) : users[0];
        });

        const [newTask, setNewTask] = useState({ name: "", description: "", date: "", priority: "Niski", link: "" });
        const [showForm, setShowForm] = useState(false);
        const [statusFilter, setStatusFilter] = useState("Wszystkie");
        const [searchQuery, setSearchQuery] = useState("");
        const [sortBy, setSortBy] = useState({});
        const [newUserName, setNewUserName] = useState("");
        const [newUserColumn, setNewUserColumn] = useState(true);

        useEffect(() => { localStorage.setItem("tasks", JSON.stringify(tasks)); }, [tasks]);
        useEffect(() => { localStorage.setItem("users", JSON.stringify(users)); }, [users]);
        useEffect(() => { localStorage.setItem("currentUser", JSON.stringify(currentUser)); }, [currentUser]);

        const handleAddTask = () => {
          if (!newTask.name.trim()) return;
          const task = {
            id: Date.now().toString(),
            ...newTask,
            createdBy: currentUser.name,
            createdAt: new Date().toLocaleString(),
            status: "Nowy",
            holdUntil: "",
          };
          setTasks({ ...tasks, unassigned: [...tasks.unassigned, task] });
          setNewTask({ name: "", description: "", date: "", priority: "Niski", link: "" });
          setShowForm(false);
        };

        const handleAddUser = () => {
          if (!newUserName.trim()) return;
          const id = newUserName.toLowerCase().replace(/\s+/g, "_");
          const newUser = { id, name: newUserName, isAdmin: false, showColumn: newUserColumn };
          setUsers([...users, newUser]);
          if (newUserColumn) setTasks({ ...tasks, [id]: [] });
          setNewUserName("");
          setNewUserColumn(true);
        };

        const handleStatusChange = (colId, taskId, newStatus) => {
          const updatedTasks = { ...tasks };
          let movedTask = null;

          Object.keys(updatedTasks).forEach(key => {
            updatedTasks[key] = updatedTasks[key].map(task => {
              if (task.id === taskId) {
                const newTask = { ...task, status: newStatus, holdUntil: newStatus !== "Wstrzymany do" ? "" : task.holdUntil };
                movedTask = newTask;
                return newTask;
              }
              return task;
            }).filter(task => task.id !== taskId);
          });

          if (movedTask.status === "Zrealizowany") {
            updatedTasks["zrealizowane"] = [...updatedTasks["zrealizowane"], movedTask];
          } else {
            updatedTasks[colId] = [...(updatedTasks[colId] || []), movedTask];
          }

          setTasks(updatedTasks);
        };

        const handleHoldDateChange = (colId, taskId, date) => {
          const updatedTasks = { ...tasks };
          updatedTasks[colId] = updatedTasks[colId].map(task =>
            task.id === taskId ? { ...task, holdUntil: date } : task
          );
          setTasks(updatedTasks);
        };

        const getStatusColor = (status) => {
          switch (status) {
            case "Nowy": return "bg-gray-300 text-gray-800";
            case "W trakcie realizacji": return "bg-yellow-300 text-yellow-900";
            case "Wstrzymany": return "bg-red-300 text-red-900";
            case "Wstrzymany do": return "bg-orange-300 text-orange-900";
            case "Zrealizowany": return "bg-green-300 text-green-900";
            default: return "bg-gray-200 text-gray-800";
          }
        };

        const columns = [
          { id: "unassigned", title: "Nieprzypisane" },
          ...users.filter(u => u.showColumn).map(u => ({ id: u.id, title: u.name })),
          { id: "zrealizowane", title: "Zrealizowane" },
        ];

        const sortTasks = (tasksArray, colId) => {
          const sortValue = sortBy[colId];
          if (!sortValue) return tasksArray;
          const sorted = [...tasksArray];
          switch (sortValue) {
            case "data": sorted.sort((a, b) => new Date(a.date) - new Date(b.date)); break;
            case "priorytet":
              const priorityOrder = { Niski: 1, ≈öredni: 2, Wysoki: 3 };
              sorted.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]); break;
            case "nazwa": sorted.sort((a, b) => a.name.localeCompare(b.name)); break;
            default: break;
          }
          return sorted;
        };

        const onDragEnd = (result) => {
          const { source, destination } = result;
          if (!destination) return;
          if (source.droppableId === destination.droppableId && source.index === destination.index) return;

          const sourceTasks = Array.from(tasks[source.droppableId]);
          const [removed] = sourceTasks.splice(source.index, 1);

          const destTasks = Array.from(tasks[destination.droppableId]);
          destTasks.splice(destination.index, 0, removed);

          setTasks({
            ...tasks,
            [source.droppableId]: sourceTasks,
            [destination.droppableId]: destTasks,
          });
        };

        return (
          <div className="flex flex-col gap-6 p-6 bg-gray-100 min-h-screen">
            <div className="bg-white shadow-md rounded-2xl p-4 flex items-center gap-4">
              <label className="font-semibold">Zalogowany jako:</label>
              <select value={currentUser.id} onChange={(e) => setCurrentUser(users.find(u => u.id === e.target.value))} className="border rounded-xl p-2">
                {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
              </select>
            </div>

            <div className="bg-white shadow-md rounded-2xl p-4">
              <button onClick={() => setShowForm(!showForm)} className="px-4 py-2 bg-green-500 text-white rounded-xl shadow hover:bg-green-600">
                {showForm ? "Anuluj" : "Dodaj nowe zadanie"}
              </button>

              {showForm && (
                <div className="mt-4">
                  <h2 className="text-lg font-bold mb-4">Nowe zadanie</h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" placeholder="Nazwa" value={newTask.name} onChange={(e) => setNewTask({ ...newTask, name: e.target.value })} className="border rounded-xl p-2" />
                    <input type="date" value={newTask.date} onChange={(e) => setNewTask({ ...newTask, date: e.target.value })} className="border rounded-xl p-2" />
                    <textarea placeholder="Opis" value={newTask.description} onChange={(e) => setNewTask({ ...newTask, description: e.target.value })} className="border rounded-xl p-2 col-span-2" />
                    <select value={newTask.priority} onChange={(e) => setNewTask({ ...newTask, priority: e.target.value })} className="border rounded-xl p-2">
                      <option>Niski</option>
                      <option>≈öredni</option>
                      <option>Wysoki</option>
                    </select>
                    <input type="url" placeholder="Link" value={newTask.link} onChange={(e) => setNewTask({ ...newTask, link: e.target.value })} className="border rounded-xl p-2" />
                  </div>
                  <button onClick={handleAddTask} className="mt-4 px-4 py-2 bg-blue-500 text-white rounded-xl shadow hover:bg-blue-600">Zapisz zadanie</button>
                </div>
              )}

              {currentUser.isAdmin && (
                <div className="mt-6">
                  <h2 className="text-lg font-bold mb-2">Dodaj u≈ºytkownika</h2>
                  <div className="flex gap-2 items-center">
                    <input type="text" placeholder="Imiƒô u≈ºytkownika" value={newUserName} onChange={(e) => setNewUserName(e.target.value)} className="border rounded-xl p-2 flex-1" />
                    <label className="text-sm flex items-center gap-1">
                      <input type="checkbox" checked={newUserColumn} onChange={(e) => setNewUserColumn(e.target.checked)} />
                      Utw√≥rz kolumnƒô dla u≈ºytkownika
                    </label>
                    <button onClick={handleAddUser} className="px-4 py-2 bg-blue-500 text-white rounded-xl">Dodaj</button>
                  </div>
                </div>
              )}
            </div>

            <div className="bg-white shadow-md rounded-2xl p-4 flex items-center gap-4 flex-wrap">
              <label className="font-semibold">Filtruj po statusie:</label>
              <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} className="border rounded-xl p-2">
                <option>Wszystkie</option>
                <option>Nowy</option>
                <option>W trakcie realizacji</option>
                <option>Wstrzymany</option>
                <option>Wstrzymany do</option>
                <option>Zrealizowany</option>
              </select>
              <input type="text" placeholder="Szukaj po nazwie lub opisie..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="border rounded-xl p-2 flex-1" />
            </div>

            <DragDropContext onDragEnd={onDragEnd}>
              <div className="flex gap-6 flex-wrap">
                {columns.map((col) => (
                  <Droppable key={col.id} droppableId={col.id}>
                    {(provided) => (
                      <div ref={provided.innerRef} {...provided.droppableProps} className="bg-white shadow-md rounded-2xl p-4 w-[320px] min-h-[400px]">
                        <div className="flex justify-between items-center mb-4">
                          <h2 className="text-xl font-bold">{col.title}</h2>
                          <select value={sortBy[col.id] || ""} onChange={(e) => setSortBy({ ...sortBy, [col.id]: e.target.value })} className="border rounded-xl p-1 text-xs">
                            <option value="">Sortuj</option>
                            <option value="data">Data</option>
                            <option value="priorytet">Priorytet</option>
                            <option value="nazwa">Nazwa</option>
                          </select>
                        </div>
                        {sortTasks(
                          tasks[col.id].filter(task => statusFilter === "Wszystkie" || task.status === statusFilter)
                                         .filter(task => task.name.toLowerCase().includes(searchQuery.toLowerCase()) || task.description.toLowerCase().includes(searchQuery.toLowerCase())),
                          col.id
                        ).map((task, index) => (
                          <Draggable key={task.id} draggableId={task.id} index={index}>
                            {(provided) => (
                              <div ref={provided.innerRef} {...provided.draggableProps} {...provided.dragHandleProps} className="p-3 mb-3 bg-blue-100 rounded-xl shadow-sm cursor-move">
                                <p className="font-bold">{task.name}</p>
                                <p className="text-sm">{task.description}</p>
                                <p className="text-xs">üìÖ {task.date} | ‚¨ÜÔ∏è {task.priority}</p>
                                {task.link && <a href={task.link} target="_blank" rel="noopener noreferrer" className="text-blue-600 text-xs">üîó Link</a>}
                                <p className="text-[10px] text-gray-500 mt-1">Utworzone przez: {task.createdBy} o {task.createdAt}</p>
                                <div className="mt-2">
                                  <label className="text-xs font-semibold mr-2">Status:</label>
                                  <select value={task.status} onChange={(e) => handleStatusChange(col.id, task.id, e.target.value)} className={`border rounded-xl p-1 text-xs ${getStatusColor(task.status)}`}>
                                    <option>Nowy</option>
                                    <option>W trakcie realizacji</option>
                                    <option>Wstrzymany</option>
                                    <option>Wstrzymany do</option>
                                    <option>Zrealizowany</option>
                                  </select>
                                </div>
                                {task.status === "Wstrzymany do" && (
                                  <div className="mt-2">
                                    <input type="date" value={task.holdUntil} onChange={(e) => handleHoldDateChange(col.id, task.id, e.target.value)} className="border rounded-xl p-1 text-xs" />
                                    {task.holdUntil && <p className="text-xs text-red-600 mt-1">‚è∏ Wstrzymany do: {task.holdUntil}</p>}
                                  </div>
                                )}
                              </div>
                            )}
                          </Draggable>
                        ))}
                        {provided.placeholder}
                      </div>
                    )}
                  </Droppable>
                ))}
              </div>
            </DragDropContext>
          </div>
        );
      }

      function App() {
        return <TaskBoard />;
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
